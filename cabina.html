<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabina de Fotos</title>
    <!-- Incluye Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body, html { 
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden; /* Evita el scroll */
        }
        .full-screen-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f3f4f6;
        }
        #webcam-video, #photo-canvas {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Asegura que el video/imagen se ajuste sin deformarse */
        }
        #take-photo-btn, #status-message, #event-title {
            position: absolute;
            z-index: 10;
        }
        #take-photo-btn {
            bottom: 2rem;
        }
        #status-message {
            bottom: 6rem;
        }
        #event-title {
            top: 2rem;
            left: 2rem;
        }
    </style>
    <!-- Importar las librerías de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="full-screen-container">
        <h1 id="event-title" class="text-4xl font-bold text-indigo-700 hidden"></h1>

        <!-- Contenedor de video y lienzo para la foto -->
        <div class="relative w-full h-full">
            <video id="webcam-video" class="w-full h-full object-cover"></video>
            <canvas id="photo-canvas" class="w-full h-full object-cover hidden"></canvas>
        </div>
        
        <!-- Mensajes de estado -->
        <p id="status-message" class="text-center text-lg text-gray-600 mb-4">
            Presiona el botón para tomar una foto.
        </p>
        
        <!-- Botón para tomar la foto -->
        <button id="take-photo-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-8 rounded-full shadow-lg transition-colors transform hover:scale-105">
            Tomar Foto
        </button>
    </div>

<script>
    // Tu código de configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAtqUp56hdHr9ShFvYyRhexFhFYG-UmBF4",
      authDomain: "cabina-1dbe7.firebaseapp.com",
      projectId: "cabina-1dbe7",
      storageBucket: "cabina-1dbe7.firebasestorage.app",
      messagingSenderId: "176812523438",
      appId: "1:176812523438:web:e78ab1c349f3dbfc58d23f",
      measurementId: "G-7YJL45YK6T"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Referencias a elementos del DOM
    const video = document.getElementById('webcam-video');
    const canvas = document.getElementById('photo-canvas');
    const takePhotoBtn = document.getElementById('take-photo-btn');
    const statusMessage = document.getElementById('status-message');
    const eventTitle = document.getElementById('event-title');
    const ctx = canvas.getContext('2d');
    
    let currentEventId = null;

    // Función para mostrar mensajes de estado
    function showStatus(message) {
        statusMessage.innerText = message;
    }

    async function setupEvent(eventId) {
        currentEventId = eventId;
        const eventDoc = await db.collection('events').doc(eventId).get();
        if (eventDoc.exists) {
            eventTitle.innerText = eventDoc.data().name;
            eventTitle.classList.remove('hidden');
            startWebcam();
        } else {
            eventTitle.innerText = 'Error: Evento no encontrado.';
            showStatus('El ID del evento no es válido o no existe.');
            takePhotoBtn.disabled = true;
        }
    }

    // Iniciar la webcam
    async function startWebcam() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            video.srcObject = stream;
            showStatus('Cámara lista. ¡Presiona el botón!');
        } catch (err) {
            console.error('Error al acceder a la cámara:', err);
            showStatus('Error: No se puede acceder a la cámara. Asegúrate de tener permisos.');
            takePhotoBtn.disabled = true;
        }
    }

    // Lógica para tomar la foto
    const takePhotoAndUpload = () => {
        if (!currentEventId) {
            showStatus('Error: No se ha seleccionado un evento.');
            return;
        }
        
        showStatus('Tomando foto...');
        video.style.display = 'none';
        canvas.style.display = 'block';
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Convertir la imagen del canvas a un blob para subirla
        canvas.toBlob((blob) => {
            const fileName = `photo_${Date.now()}.png`;
            const storageRef = storage.ref(`photos/${currentEventId}/${fileName}`);

            // Subir el archivo a Firebase Storage
            const uploadTask = storageRef.put(blob);
            
            uploadTask.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    showStatus(`Subiendo foto: ${Math.round(progress)}%`);
                }, 
                (error) => {
                    console.error('Error al subir la foto:', error);
                    showStatus('Hubo un error al subir la foto.');
                }, 
                () => {
                    // Una vez que la subida termina, obtiene la URL y la guarda en la base de datos
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        db.collection('events').doc(currentEventId).collection('photos').add({
                            url: downloadURL,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }).then(() => {
                            showStatus('¡Foto subida con éxito! ¡Listo para la siguiente!');
                            setTimeout(() => {
                                video.style.display = 'block';
                                canvas.style.display = 'none';
                                showStatus('Presiona el botón para tomar otra foto.');
                            }, 3000);
                        }).catch(err => {
                            console.error('Error al guardar la URL en Firestore:', err);
                            showStatus('Error al guardar la foto en la base de datos.');
                        });
                    });
                }
            );
        }, 'image/png');
    };

    takePhotoBtn.addEventListener('click', takePhotoAndUpload);

    // Iniciar la cámara al cargar la página y autenticar
    document.addEventListener('DOMContentLoaded', () => {
        auth.onAuthStateChanged(user => {
            if (user) {
                const urlParams = new URLSearchParams(window.location.search);
                const eventId = urlParams.get('id');
                if (eventId) {
                    setupEvent(eventId);
                } else {
                    eventTitle.innerText = 'Error: Sin ID de evento';
                    showStatus('Por favor, ingresa a esta página a través del panel de administración.');
                    takePhotoBtn.disabled = true;
                }
            } else {
                auth.signInAnonymously().catch(error => {
                    console.error("Error al iniciar sesión anónimamente:", error);
                    eventTitle.innerText = 'Error de autenticación';
                    showStatus("No se pudo iniciar sesión. No podrás tomar fotos.");
                    takePhotoBtn.disabled = true;
                });
            }
        });
    });

</script>
</body>
</html>
