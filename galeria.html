<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galería del Evento</title>
    <!-- Incluye Tailwind CSS para un diseño moderno y responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
    <!-- Importar las librerías de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 p-8 text-gray-800">

    <div class="text-center mb-10">
        <h1 class="text-4xl font-bold mb-2 text-indigo-700">Galería del Evento</h1>
        <p id="event-title" class="text-2xl font-semibold text-gray-700">Cargando...</p>
        <p class="text-lg text-gray-600">
            ¡Tus fotos aparecen aquí en tiempo real!
        </p>
    </div>

    <!-- Sección de botones -->
    <div class="max-w-xl mx-auto mb-8 flex flex-col sm:flex-row gap-4 justify-center items-center">
        <button id="uploadPhotoBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-colors">
            Subir Foto
        </button>
        <input type="file" id="photoFile" class="hidden" accept="image/*">
        <button id="downloadAllBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-colors hidden">
            Descargar Todas
        </button>
    </div>
    <p id="status-message" class="text-center text-sm text-gray-500 mt-2"></p>

    <!-- Contenedor de la galería de fotos -->
    <div id="gallery-container" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 justify-items-center">
        <!-- Las fotos se cargarán aquí -->
    </div>

    <!-- Botón para volver arriba -->
    <button id="scrollToTopBtn" class="fixed bottom-8 right-8 bg-indigo-600 text-white rounded-full p-3 shadow-lg hidden transition-transform transform hover:scale-110">
        <svg xmlns="http://www.w3.org/2-11/xhtml" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
        </svg>
    </button>

<script>
    // Tu código de configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAtqUp56hdHr9ShFvYyRhexFhFYG-UmBF4",
      authDomain: "cabina-1dbe7.firebaseapp.com",
      projectId: "cabina-1dbe7",
      storageBucket: "cabina-1dbe7.firebasestorage.app",
      messagingSenderId: "176812523438",
      appId: "1:176812523438:web:e78ab1c349f3dbfc58d23f",
      measurementId: "G-7YJL45YK6T"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Referencias a los elementos del DOM
    const galleryContainer = document.getElementById('gallery-container');
    const scrollToTopBtn = document.getElementById('scrollToTopBtn');
    const eventTitle = document.getElementById('event-title');
    const uploadPhotoBtn = document.getElementById('uploadPhotoBtn');
    const photoFile = document.getElementById('photoFile');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const statusMessage = document.getElementById('status-message');

    let unsubscribe = null; // Variable para almacenar la función de desuscripción del listener
    let currentEventId = null;

    function showStatus(message) {
        statusMessage.innerText = message;
    }

    async function setupGalleryListener(eventId) {
        if (unsubscribe) {
            unsubscribe(); // Desuscribirse del listener anterior si existe
        }
        
        currentEventId = eventId;
        showStatus('');
        downloadAllBtn.classList.add('hidden');

        // Obtener el nombre del evento
        const eventDoc = await db.collection('events').doc(eventId).get();
        if (eventDoc.exists) {
            const eventData = eventDoc.data();
            eventTitle.innerText = eventData.name;
        } else {
            eventTitle.innerText = 'Evento no encontrado.';
            galleryContainer.innerHTML = `
                <div class="text-xl font-semibold text-red-500 col-span-full">
                    Error: El ID de evento no es válido o no existe.
                </div>
            `;
            return;
        }

        // Configurar un nuevo listener para el evento seleccionado
        unsubscribe = db.collection('events').doc(eventId).collection('photos').orderBy('timestamp', 'desc').onSnapshot((snapshot) => {
            galleryContainer.innerHTML = '';
            
            if (snapshot.empty) {
                galleryContainer.innerHTML = `
                    <div class="text-xl font-semibold text-gray-500 col-span-full">
                        No hay fotos en este evento. ¡Sube la primera!
                    </div>
                `;
                downloadAllBtn.classList.add('hidden');
            } else {
                downloadAllBtn.classList.remove('hidden');
                snapshot.forEach((doc) => {
                    const photo = doc.data();
                    const photoCard = document.createElement('div');
                    photoCard.className = 'bg-white p-2 rounded-xl shadow-md transform transition-transform hover:scale-105';
                    photoCard.innerHTML = `
                        <img src="${photo.url}" alt="Foto del evento" class="rounded-lg w-full h-auto object-cover">
                        <a href="${photo.url}" class="mt-2 block bg-indigo-600 hover:bg-indigo-700 text-white text-center py-2 px-4 rounded-full text-sm font-semibold transition-colors" download>
                            Descargar
                        </a>
                    `;
                    galleryContainer.appendChild(photoCard);
                });
            }
        }, (error) => {
            console.error('Error al escuchar las fotos:', error);
            galleryContainer.innerHTML = `
                <div class="text-xl font-semibold text-red-500 col-span-full">
                    Hubo un problema al cargar la galería.
                </div>
            `;
            downloadAllBtn.classList.add('hidden');
        });
    }

    // Obtener el ID del evento de la URL al cargar la página
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('id');
        if (eventId) {
            setupGalleryListener(eventId);
        } else {
            eventTitle.innerText = 'No se encontró un evento válido.';
            galleryContainer.innerHTML = `
                <div class="text-xl font-semibold text-gray-500 col-span-full">
                    Escanea el código QR de tu evento para ver la galería.
                </div>
            `;
        }
    });

    // Lógica para el botón de "Subir Foto"
    uploadPhotoBtn.addEventListener('click', () => {
        if (!currentEventId) {
            showStatus('¡Escanea el QR de un evento válido para subir fotos!');
            return;
        }
        photoFile.click();
    });
    
    // Lógica para subir la foto una vez que se ha seleccionado
    photoFile.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) {
            showStatus('Carga de foto cancelada.');
            return;
        }

        showStatus('Subiendo foto...');
        
        // Sube el archivo a Firebase Storage
        const storageRef = storage.ref(`photos/${currentEventId}/${Date.now()}_${file.name}`);
        const uploadTask = storageRef.put(file);

        uploadTask.on('state_changed', 
            (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                showStatus(`Progreso de subida: ${Math.round(progress)}%`);
            }, 
            (error) => {
                console.error(error);
                showStatus('Hubo un error al subir la foto.');
            }, 
            () => {
                // Una vez que la subida termina, obtiene la URL y la guarda en la subcolección de Firestore
                uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                    db.collection('events').doc(currentEventId).collection('photos').add({
                        url: downloadURL,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    }).then(() => {
                        showStatus('¡Foto subida con éxito!');
                        photoFile.value = ''; // Limpia el input para la siguiente foto
                    }).catch(err => {
                        console.error(err);
                        showStatus('Error al registrar la foto en la base de datos.');
                    });
                });
            }
        );
    });

    // Lógica para el botón de "Descargar Todas"
    downloadAllBtn.addEventListener('click', async () => {
        if (!currentEventId) return;

        showStatus('Preparando la descarga de todas las fotos...');

        try {
            const photosSnapshot = await db.collection('events').doc(currentEventId).collection('photos').orderBy('timestamp', 'asc').get();
            if (photosSnapshot.empty) {
                showStatus('No hay fotos para descargar.');
                return;
            }

            const photos = photosSnapshot.docs.map(doc => doc.data().url);
            showStatus(`Iniciando la descarga de ${photos.length} fotos...`);

            // Itera sobre las fotos y crea un enlace de descarga para cada una
            for (let i = 0; i < photos.length; i++) {
                const url = photos[i];
                const link = document.createElement('a');
                link.href = url;
                link.download = `foto_${i + 1}.jpg`;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            showStatus('Descarga completada.');

        } catch (error) {
            console.error('Error al descargar todas las fotos:', error);
            showStatus('Hubo un error al descargar todas las fotos.');
        }
    });

    // Lógica para el botón de "volver arriba"
    window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
            scrollToTopBtn.classList.remove('hidden');
        } else {
            scrollToTopBtn.classList.add('hidden');
        }
    });

    scrollToTopBtn.addEventListener('click', () => {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });

</script>

</body>
</html>
